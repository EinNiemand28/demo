<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body p-5">
          <h4 class="card-title text-center mb-4">
            <i class="bi bi-shield-lock me-2"></i>修改密码
          </h4>

          <%= form_with(url: password_path, data: { turbo: false }, method: :patch, class: "needs-validation") do |form| %>
            <div class="form-floating mb-3">
              <%= form.password_field :password_challenge,
                    class: "form-control",
                    placeholder: "当前密码" %>
              <%= form.label :password_challenge do %>
                <i class="bi bi-key-fill me-1"></i>当前密码
              <% end %>
            </div>

            <div class="form-floating mb-3">
              <%= form.password_field :password,
                    class: "form-control",
                    placeholder: "新密码" %>
              <%= form.label :password do %>
                <i class="bi bi-lock-fill me-1"></i>新密码
              <% end %>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>密码长度至少6位
              </div>
            </div>

            <div class="form-floating mb-4">
              <%= form.password_field :password_confirmation,
                    class: "form-control",
                    placeholder: "确认新密码" %>
              <%= form.label :password_confirmation do %>
                <i class="bi bi-check2-circle me-1"></i>确认新密码
              <% end %>
            </div>

            <div class="d-grid gap-2">
              <%= form.submit "确认更改", class: "btn btn-primary btn-lg" %>
              <%= link_to "返回", user_path(@user), class: "btn btn-light" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :page_scripts do %>
<script>
(() => {
  'use strict'

  const forms = document.querySelectorAll('.needs-validation')

  Array.from(forms).forEach(form => {
    form.addEventListener('submit', (event) => {
      event.preventDefault()
      event.stopPropagation()

      const formData = new FormData(form)
      const pwdData = {}
      formData.forEach((value, key) => {
        pwdData[key] = value
      })

      fetch(form.action, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify(pwdData)
      })
      .then(responce => responce.json())
      .then(data => {
        if (data.success) {
          showToast({
            message: data.message,
            type: 'success',
            redirect: data.redirect_url,
            delay: 1500
          })
        } else {
          showToast({
            message: data.message,
            type: 'danger',
            errors: data.errors,
            delay: 3000
          })
        }
      })
      .catch(error => {
        showToast({
          message: '系统错误, 请稍后重试',
          type: 'danger',
          delay: 3000
        })
      })
    }, false)
  })
  
})()
</script>
<% end %>