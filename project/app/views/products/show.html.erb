<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-sm">
        <div class="card-body p-5">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="card-title mb-0">
              <i class="bi bi-box-seam me-2"></i><%= @product.name %>
            </h3>
            <% if Current.user&.admin? || Current.user&.worker? %>
              <div class="btn-group">
                <%= link_to edit_product_path(@product), class: "btn btn-sm btn-outline-primary" do %>
                  <i class="bi bi-pencil"></i> 编辑
                <% end %>
                <%= button_to product_path(@product), 
                      method: :delete,
                      class: "btn btn-sm btn-outline-danger",
                      form: { class: 'd-inline-block' },
                      data: { action: "delete-product",
                             product_id: @product.id } do %>
                  <i class="bi bi-trash"></i> 删除
                <% end %>
              </div>
            <% end %>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <% if @product.image.attached? %>
                <%= image_tag @product.image_variant(:image), class: "img-fluid rounded mb-3" %>
              <% else %>
                <%= image_tag "default_product.png", class: "img-fluid rounded mb-3" %>
              <% end %>
            </div>
            <div class="col-md-6">
              <div class="mb-4">
                <h6 class="text-muted mb-2 fs-4">商品描述</h6>
                <p class="card-text lh-lg mx-4" style="text-indent: 0; color: #2c3e50; white-space: pre-line;">
                  <%= @product.description %>
                </p>
              </div>
              <hr class="my-4">
              <div class="mb-3">
                <h6 class="text-muted mb-2">价格</h6>
                <span class="badge bg-danger px-3 py-2 fs-5">
                  ¥<%= number_with_precision(@product.price, precision: 2) %>
                </span>
              </div>
              <div class="mb-3">
                <h6 class="text-muted mb-2">库存</h6>
                <span class="badge bg-light text-dark border fs-6">
                  <i class="bi bi-box-seam me-1"></i><%= @product.stock %> 件
                </span>
              </div>
              <div class="mb-3">
                <h6 class="text-muted mb-2">分类</h6>
                <span class="badge bg-light text-secondary border fs-6">
                  <i class="bi bi-diagram-2 me-1"></i><%= @product.category.full_path %>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :page_scripts do %>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-action="delete-product"]').forEach(button => {
    button.addEventListener('click', (e) => {
      e.preventDefault()
      const form = e.target.closest('form')
      
      if (confirm('确定要删除此商品吗？')) {
        fetch(form.action, {
          method: 'DELETE',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast({
              message: data.message,
              type: 'success',
              delay: 1500
            })
            setTimeout(() => {
              window.location.href = data.redirect_url
            }, 1500)
          } else {
            showToast({
              message: data.message || '删除失败',
              type: 'danger',
              errors: data.errors,
              delay: 3000
            })
          }
        })
        .catch(error => {
          showToast({
            message: '系统错误，请稍后重试',
            type: 'danger',
            delay: 3000
          })
        })
      }
    })
  })
})
</script>
<% end %>