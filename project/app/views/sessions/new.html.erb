<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-body p-5">
          <h2 class="card-title text-center mb-4">登录</h2>

          <%= form_with(url: sign_in_path, class: "needs-validation", novalidate: true) do |form| %>
            <div class="form-floating mb-3">
              <%= form.text_field :login, 
                    class: "form-control",
                    required: true,
                    placeholder: "请输入账号" %>
              <%= form.label :login, "用户名/邮箱/手机号" %>
              <div class="invalid-feedback">
                请输入账号
              </div>
            </div>

            <div class="form-floating mb-3">
              <%= form.password_field :password,
                    class: "form-control",
                    required: true,
                    placeholder: "请输入密码" %>
              <%= form.label :password, "密码" %>
              <div class="invalid-feedback">
                请输入密码
              </div>
            </div>

            <div class="d-grid gap-2">
              <%= form.submit "登录", class: "btn btn-primary btn-lg" %>
            </div>
          <% end %>

          <div class="text-center mt-4">
            <p class="text-muted">
              还没有账号？
              <%= link_to "立即注册", sign_up_path, class: "text-decoration-none" %>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :page_scripts do %>
<script>
(() => {
  'use strict'

  const forms = document.querySelectorAll('.needs-validation')

  const checkInputValidity = (input) => {
    const isValid = input.value && input.checkValidity()
    
    input.classList.toggle('is-valid', isValid)
    input.classList.toggle('is-invalid', !isValid)
    
    return isValid
  }

  Array.from(forms).forEach(form => {
    const inputs = form.querySelectorAll('input')

    inputs.forEach(input => {
      input.addEventListener('input', () => {
        checkInputValidity(input)
      })
      
      input.addEventListener('blur', () => {
        checkInputValidity(input)
      })
    })

    form.addEventListener('submit', event => {
      event.preventDefault()
      event.stopPropagation()

      const formData = new FormData(form)
      const loginData = {}
      formData.forEach((value, key) => {
        loginData[key] = value
      })

      fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(loginData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const successDiv = document.createElement('div')
          successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed'
          successDiv.style.cssText = `
            z-index: 1050;
            left: 50%;
            top: 1rem;
            transform: translateX(-50%);
            min-width: 300px;
            text-align: center;
          `
          successDiv.innerHTML = `
            <div class="d-flex align-items-center">
              <strong>${data.message}</strong>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `
          document.body.appendChild(successDiv)

          setTimeout(() => {
            window.location.href = data.redirect_url
          }, 1000)
        } else {
          const errorDiv = document.createElement('div')
          errorDiv.className = 'alert alert-danger alert-dismissible fade show'
          errorDiv.innerHTML = `
            <div class="d-flex align-items-center">
              <strong>${data.message}</strong>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `
          form.parentNode.insertBefore(errorDiv, form)
        }
      })

      form.classList.add('was-validated')
    }, false)
  })
})()
</script>
<% end %>