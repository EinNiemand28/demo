<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="card-title mb-0">
          <i class="bi bi-cart me-2"></i>我的购物车
        </h4>
        <%= link_to products_path, class: "btn btn-primary" do %>
          <i class="bi bi-plus-lg me-1"></i>继续购物
        <% end %>
      </div>

      <% if @cart_items.any? %>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>商品信息</th>
                <th>单价</th>
                <th>数量</th>
                <th>小计</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <% @cart_items.each do |item| %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <%= image_tag item.product.image_variant(:thumb),
                            class: "rounded me-3",
                            style: "width: 64px; height: 64px; object-fit: cover;" %>
                      <div>
                        <h5 class="card-title mb-1">
                          <i class="bi bi-box-seam me-1"></i>
                          <%= link_to item.product.name, 
                                product_path(item.product), 
                                class: "text-decoration-none text-primary" %>
                        </h5>
                        <div class="text-muted small">
                          <%= truncate(item.product.description, length: 50) %>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="text-danger fw-bold">
                      ¥<%= number_with_precision(item.product.price, precision: 2) %>
                    </span>
                  </td>
                  <td style="width: 180px;">
                    <div class="input-group">
                      <button class="btn btn-outline-secondary px-3" type="button" 
                              data-action="decrease-quantity"
                              data-item-id="<%= item.id %>">
                        <i class="bi bi-dash"></i>
                      </button>
                      <input type="number" 
                            class="form-control text-center px-2" 
                            style="min-width: 65px;"
                            value="<%= item.quantity %>"
                            min="1" 
                            max="<%= item.product.stock %>"
                            data-action="update-quantity"
                            data-item-id="<%= item.id %>">
                      <button class="btn btn-outline-secondary px-3" type="button"
                              data-action="increase-quantity"
                              data-item-id="<%= item.id %>">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </td>
                  <td>
                    <span class="text-danger fw-bold">
                      ¥<%= number_with_precision(item.product.price * item.quantity, precision: 2) %>
                    </span>
                  </td>
                  <td>
                    <button type="button" 
                            class="btn btn-sm btn-outline-danger"
                            data-action="remove-item"
                            data-item-id="<%= item.id %>">
                      <i class="bi bi-trash me-1"></i>删除
                    </button>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- 合计栏 -->
        <div class="d-flex justify-content-end align-items-center mt-4">
          <div class="me-4">
            <span class="fs-5">合计金额：</span>
            <span class="text-danger fs-4 fw-bold">
              ¥<%= number_with_precision(@cart.total_price, precision: 2) %>
            </span>
          </div>
          <button type="button" 
                  class="btn btn-danger btn-lg px-5"
                  data-bs-toggle="modal" 
                  data-bs-target="#checkoutModal">
            <i class="bi bi-wallet2 me-2"></i>去结算
          </button>
        </div>
      <% else %>
        <!-- 空购物车显示 -->
        <div class="text-center py-5">
          <i class="bi bi-cart-x text-muted" style="font-size: 4rem;"></i>
          <h5 class="mt-3 text-muted">购物车还是空的</h5>
          <%= link_to products_path, class: "btn btn-primary mt-3" do %>
            <i class="bi bi-shop me-1"></i>去逛逛
          <% end %>
        </div>
      <% end %>

      <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">选择收货地址</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <% if Current.user.addresses.any? %>
                <% Current.user.addresses.each do |address| %>
                  <div class="card mb-2">
                    <div class="card-body">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" 
                              name="address" value="<%= address.id %>"
                              id="address_<%= address.id %>"
                              <%= 'checked' if address.is_default %>>
                        <label class="form-check-label" for="address_<%= address.id %>">
                          <h6 class="mb-1"><%= address.name %> <span class="text-muted"><%= address.phone %></span></h6>
                          <p class="mb-1 text-muted small"><%= address.postcode %></p>
                          <p class="mb-0"><%= address.content %></p>
                        </label>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div class="text-center py-3">
                  <p class="text-muted">您还没有添加收货地址</p>
                  <%= link_to user_path(Current.user),
                        class: "btn btn-primary" do %>
                    <i class="bi bi-plus-lg me-1"></i>新增地址
                  <% end %>
                </div>
              <% end %>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" data-action="create-order">确认下单</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :page_scripts do %>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const updateQuantity = (itemId, quantity) => {
    fetch(`/cart/cart_items/${itemId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ cart_item: { quantity: quantity } })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload()
      } else {
        showToast({
          message: data.message,
          type: 'danger',
          errors: data.errors,
          delay: 3000
        })
      }
    })
    .catch(() => {
      showToast({
        message: '系统错误，请稍后重试',
        type: 'danger',
        delay: 3000
      })
    })
  }

  document.querySelectorAll('[data-action="decrease-quantity"]').forEach(button => {
    button.addEventListener('click', (e) => {
      const itemId = e.target.closest('[data-action="decrease-quantity"]').dataset.itemId
      const input = document.querySelector(`input[data-item-id="${itemId}"]`)
      const newValue = parseInt(input.value) - 1
      if (newValue >= 1) {
        updateQuantity(itemId, newValue)
      }
    })
  })

  document.querySelectorAll('[data-action="increase-quantity"]').forEach(button => {
    button.addEventListener('click', (e) => {
      const itemId = e.target.closest('[data-action="increase-quantity"]').dataset.itemId
      const input = document.querySelector(`input[data-item-id="${itemId}"]`)
      const newValue = parseInt(input.value) + 1
      if (newValue <= parseInt(input.max)) {
        updateQuantity(itemId, newValue)
      }
    })
  })

  document.querySelectorAll('[data-action="update-quantity"]').forEach(input => {
    input.addEventListener('change', (e) => {
      const itemId = e.target.dataset.itemId
      const newValue = parseInt(e.target.value)
      if (newValue >= 1 && newValue <= parseInt(e.target.max)) {
        updateQuantity(itemId, newValue)
      }
    })
  })

  document.querySelectorAll('[data-action="remove-item"]').forEach(button => {
    button.addEventListener('click', (e) => {
      const itemId = e.target.closest('[data-action="remove-item"]').dataset.itemId
      
      if (confirm('确定要从购物车中移除此商品吗？')) {
        fetch(`/cart/cart_items/${itemId}`, {
          method: 'DELETE',
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          }
        })
        .then(response => response.json())
        .then(data => {
          console.log(data)
          if (data.success) {
            showToast({
              message: data.message,
              type: 'success',
              delay: 1000
            })
            setTimeout(() => {
              window.location.reload()
            }, 1000);
          } else {
            showToast({
              message: data.message,
              type: 'danger',
              delay: 3000
            })
          }
        })
        .catch(() => {
          showToast({
            message: '系统错误，请稍后重试',
            type: 'danger',
            delay: 3000
          })
        })
      }
    })
  })

  document.querySelector('[data-action="create-order"]')?.addEventListener('click', (e) => {
    const addressId = document.querySelector('input[name="address"]:checked')?.value
    fetch('/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ address_id: addressId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast({
          message: data.message,
          type: 'success',
          delay: 1500,
          redirect: data.redirect_url
        })
      } else {
        showToast({
          message: data.message,
          type: 'danger',
          errors: data.errors,
          delay: 3000
        })
      }
    })
  })
})
</script>
<% end %>