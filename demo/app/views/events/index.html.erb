<h1>活动列表</h1>

<% if user_signed_in? && (current_user.admin? || current_user.teacher?) %>
  <%= link_to '创建新活动', new_event_path %>
<% end %>

<h2>所有活动</h2>
<table>
  <thead>
    <tr>
      <th>标题</th>
      <th>描述</th>
      <th>开始时间</th>
      <th>结束时间</th>
      <th>地点</th>
      <th>状态</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <% @events.each do |event| %>
      <tr>
        <td><%= link_to event.title, event_path(event) %></td>
        <td><%= truncate(event.description, length: 50) %></td>
        <td><%= format_datetime(event.start_time) %></td>
        <td><%= format_datetime(event.end_time) %></td>
        <td><%= event.location %></td>
        <td><%= event.status.humanize %></td>
        <td>
          <%= link_to '查看', event_path(event) %>
          <% if current_user.admin? %>
            <%= link_to '编辑', edit_event_path(event) %>
            <%= link_to '删除', event_path(event), data: {
              turbo_method: :delete,
              turbo_confirm: "确定要删除活动 #{event.title} 吗？"
            } %>
            <%= link_to '取消活动', cancel_event_path(event), data: {
              turbo_method: :patch,
              turbo_confirm: "确定要取消活动 #{event.title} 吗？"
            } %>
          <% end %>
          <% if current_user.student? && event.status == 'upcoming' %>
            <%= link_to '报名参加', event_student_events_path(event), data: { turbo_method: :post } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<% if current_user.admin? || current_user.teacher? %>
  <h2>待批准活动</h2>
  <table>
    <thead>
      <tr>
        <th>标题</th>
        <th>描述</th>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>地点</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @pending_events.each do |event| %>
        <tr>
          <td><%= link_to event.title, event_path(event) %></td>
          <td><%= truncate(event.description, length: 50) %></td>
          <td><%= format_datetime(event.start_time) %></td>
          <td><%= format_datetime(event.end_time) %></td>
          <td><%= event.location %></td>
          <td><%= event.status.humanize %></td>
          <td>
            <%= link_to '查看', event_path(event) %>
            <% if current_user.admin? || event.organizer_teacher == current_user %>
              <%= link_to '编辑', edit_event_path(event) %>
              <%= link_to '删除', event_path(event), data: {
                turbo_method: :delete,
                turbo_confirm: "确定要删除活动 #{event.title} 吗？"
              } %>
            <% end %>
            <% if current_user.admin? && event.status == 'pending' %>
              <%= link_to '批准活动', approve_event_path(event), data: {
                turbo_method: :patch,
                turbo_confirm: "确定要批准活动 #{event.title} 吗？"
              } %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<% if current_user.student? %>
  <h2>已报名活动</h2>
  <table>
    <thead>
      <tr>
        <th>标题</th>
        <th>描述</th>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>地点</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @registered_events.each do |event| %>
        <tr>
          <td><%= link_to event.title, event_path(event) %></td>
          <td><%= truncate(event.description, length: 50) %></td>
          <td><%= format_datetime(event.start_time) %></td>
          <td><%= format_datetime(event.end_time) %></td>
          <td><%= event.location %></td>
          <td><%= event.status.humanize %></td>
          <td>
            <%= link_to '查看', event_path(event) %>
            <% if event.status == "upcoming" %>
              <%= link_to '取消报名', event_student_event_path(event, current_user.student_events.find_by(event: event)), data: { turbo_method: :delete } %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h2>已申请的志愿者岗位</h2>
  <table>
    <thead>
      <tr>
        <th>活动</th>
        <th>岗位名称</th>
        <th>志愿时长</th>
        <th>报名截止时间</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% current_user.student_volunteer_positions.includes(:volunteer_position => :event).each do |registration| %>
        <tr>
          <td><%= link_to registration.volunteer_position.event.title, event_path(registration.volunteer_position.event) %></td>
          <td><%= registration.volunteer_position.name %></td>
          <td><%= registration.volunteer_position.volunteer_hours %> 小时</td>
          <td><%= format_datetime(registration.volunteer_position.registration_deadline) %></td>
          <td><%= registration.status.humanize %></td>
          <td>
            <% if registration.pending? %>
              <%= button_to '取消申请', cancel_event_volunteer_position_path(registration.volunteer_position.event, registration.volunteer_position), method: :patch, data: { turbo_confirm: "确定要取消申请吗？" } %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<% if current_user.teacher? %>
  <h2>关联的活动</h2>
  <table>
    <thead>
      <tr>
        <th>标题</th>
        <th>描述</th>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>地点</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @associated_events.each do |event| %>
        <tr>
          <td><%= link_to event.title, event_path(event) %></td>
          <td><%= truncate(event.description, length: 50) %></td>
          <td><%= format_datetime(event.start_time) %></td>
          <td><%= format_datetime(event.end_time) %></td>
          <td><%= event.location %></td>
          <td><%= event.status.humanize %></td>
          <td>
            <%= link_to '查看', event_path(event) %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <h2>组织的活动</h2>
  <table>
    <thead>
      <tr>
        <th>标题</th>
        <th>描述</th>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>地点</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @organized_events.each do |event| %>
        <tr>
          <td><%= link_to event.title, event_path(event) %></td>
          <td><%= truncate(event.description, length: 50) %></td>
          <td><%= format_datetime(event.start_time) %></td>
          <td><%= format_datetime(event.end_time) %></td>
          <td><%= event.location %></td>
          <td><%= event.status.humanize %></td>
          <td>
            <%= link_to '查看', event_path(event) %>
            <%= link_to '编辑', edit_event_path(event) %>
            <% if event.status != 'canceled' %>
              <%= link_to '取消活动', cancel_event_path(event), data: {
                turbo_method: :patch,
                turbo_confirm: "确定要取消活动 #{event.title} 吗？"
              } %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
<% end %>