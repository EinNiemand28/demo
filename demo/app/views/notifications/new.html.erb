<h1>发送新通知</h1>

<div class="notification-form">
  <%# 搜索表单 %>
  <div class="search-section">
    <h3>搜索用户</h3>
    <%= search_form_for @q, url: new_notification_path, method: :get do |f| %>
      <div class="search-fields">
        <div>
          <%= f.label :name_cont, "姓名包含" %>
          <%= f.search_field :name_cont %>
        </div>
        
        <div>
          <%= f.label :role_level_eq, "用户类型" %>
          <%= f.select :role_level_eq, 
              User.role_levels.map { |k,v| [k.humanize, v] },
              include_blank: "全部" %>
        </div>
        
        <%= f.submit "搜索用户", class: 'button' %>
      </div>
    <% end %>
  </div>

  <%# 通知创建表单 %>
  <%= form_with(model: @notification, local: true, class: 'create-notification') do |f| %>
    <% if @notification.errors.any? %>
      <div class="error-messages">
        <ul>
          <% @notification.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="field">
      <%= f.label :content, "通知内容" %>
      <%= f.text_area :content, required: true %>
    </div>

    <div class="field">
      <h3>接收用户</h3>
      <div class="users-table">
        <table>
          <thead>
            <tr>
              <th><%= check_box_tag 'select_all', '', false, onclick: 'toggleAll(this)' %></th>
              <th>姓名</th>
              <th>邮箱</th>
              <th>类型</th>
            </tr>
          </thead>
          <tbody>
            <% @users.each do |user| %>
              <tr>
                <td><%= check_box_tag 'user_ids[]', user.id, false, class: 'user-checkbox' %></td>
                <td><%= user.name %></td>
                <td><%= user.email %></td>
                <td><%= user.role_level.humanize %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <%= paginate @users %>
    </div>

    <%= f.submit "发送通知", class: 'button primary', data: { disable_with: '发送中...' } %>
  <% end %>
</div>

<script>
function toggleAll(source) {
  var checkboxes = document.getElementsByClassName('user-checkbox');
  for(var i=0; i < checkboxes.length; i++) {
    checkboxes[i].checked = source.checked;
  }
}
</script>

<style>
.notification-form {
  max-width: 800px;
  margin: 0 auto;
}

.search-section {
  margin-bottom: 20px;
  padding: 15px;
  background: #f5f5f5;
  border-radius: 5px;
}

.search-fields {
  display: flex;
  gap: 15px;
  align-items: end;
}

.field {
  margin-bottom: 20px;
}

.users-table {
  margin: 15px 0;
  max-height: 400px;
  overflow-y: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 8px;
  border: 1px solid #ddd;
}

.button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.button.primary {
  background: #007bff;
  color: white;
}

.error-messages {
  color: red;
  margin-bottom: 15px;
}
</style>